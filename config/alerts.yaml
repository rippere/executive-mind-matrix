# Prometheus Alerting Rules for Executive Mind Matrix
# These rules define alerts that will be triggered when certain conditions are met

groups:
  - name: executive_mind_matrix_alerts
    interval: 30s
    rules:
      # Service availability alerts
      - alert: ServiceDown
        expr: up{job="executive-mind-matrix"} == 0
        for: 1m
        labels:
          severity: critical
          component: service
        annotations:
          summary: "Executive Mind Matrix service is down"
          description: "The Executive Mind Matrix service has been down for more than 1 minute."

      - alert: HighErrorRate
        expr: rate(errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: errors
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanize }} errors per second."

      # Poller health alerts
      - alert: PollerNotRunning
        expr: poller_status == 0
        for: 5m
        labels:
          severity: critical
          component: poller
        annotations:
          summary: "Poller is not running"
          description: "The Notion poller has been stopped for more than 5 minutes."

      - alert: PollerSlowCycles
        expr: histogram_quantile(0.95, rate(poll_cycle_duration_seconds_bucket[5m])) > 30
        for: 10m
        labels:
          severity: warning
          component: poller
        annotations:
          summary: "Poller cycles are slow"
          description: "95th percentile of poll cycle duration is {{ $value | humanize }}s (threshold: 30s)."

      # API performance alerts
      - alert: HighNotionAPILatency
        expr: histogram_quantile(0.95, rate(notion_api_request_duration_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          component: notion_api
        annotations:
          summary: "High Notion API latency"
          description: "95th percentile of Notion API requests is {{ $value | humanize }}s."

      - alert: NotionAPIErrors
        expr: rate(notion_api_requests_total{status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: notion_api
        annotations:
          summary: "Notion API errors detected"
          description: "Notion API error rate is {{ $value | humanize }} errors per second."

      - alert: HighAnthropicAPILatency
        expr: histogram_quantile(0.95, rate(anthropic_api_request_duration_seconds_bucket[5m])) > 10
        for: 10m
        labels:
          severity: warning
          component: anthropic_api
        annotations:
          summary: "High Anthropic API latency"
          description: "95th percentile of Anthropic API requests is {{ $value | humanize }}s."

      - alert: AnthropicAPIErrors
        expr: rate(anthropic_api_requests_total{status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: anthropic_api
        annotations:
          summary: "Anthropic API errors detected"
          description: "Anthropic API error rate is {{ $value | humanize }} errors per second."

      # Token usage alerts
      - alert: HighTokenUsage
        expr: rate(anthropic_tokens_used_total[1h]) > 100000
        for: 1h
        labels:
          severity: info
          component: cost
        annotations:
          summary: "High Anthropic token usage"
          description: "Token usage rate is {{ $value | humanize }} tokens per second, which may result in high costs."

      # Response time alerts
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "High HTTP response time"
          description: "95th percentile response time is {{ $value | humanize }}s (threshold: 2s)."

      # Agent performance alerts
      - alert: AgentAnalysisFailures
        expr: rate(agent_analyses_total{status="error"}[10m]) > 0.1
        for: 10m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent analysis failures detected"
          description: "Agent {{ $labels.agent }} has failure rate of {{ $value | humanize }} per second."

      # Resource alerts
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 1
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanize }} GB."

      - alert: TooManyActiveTasks
        expr: active_tasks > 100
        for: 10m
        labels:
          severity: warning
          component: tasks
        annotations:
          summary: "Too many active background tasks"
          description: "There are {{ $value }} active background tasks, which may indicate a processing bottleneck."

  - name: executive_mind_matrix_slo
    interval: 30s
    rules:
      # Service Level Objectives (SLOs)
      - alert: AvailabilitySLOBreach
        expr: avg_over_time(up{job="executive-mind-matrix"}[1h]) < 0.999
        for: 5m
        labels:
          severity: critical
          component: slo
        annotations:
          summary: "Availability SLO breach"
          description: "Service availability over the last hour is {{ $value | humanizePercentage }}, below the 99.9% SLO."

      - alert: LatencySLOBreach
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[1h])) > 1
        for: 10m
        labels:
          severity: warning
          component: slo
        annotations:
          summary: "Latency SLO breach"
          description: "95th percentile latency over the last hour is {{ $value | humanize }}s, above the 1s SLO."

      - alert: ErrorRateSLOBreach
        expr: (rate(errors_total[1h]) / rate(http_requests_total[1h])) > 0.01
        for: 10m
        labels:
          severity: warning
          component: slo
        annotations:
          summary: "Error rate SLO breach"
          description: "Error rate over the last hour is {{ $value | humanizePercentage }}, above the 1% SLO."

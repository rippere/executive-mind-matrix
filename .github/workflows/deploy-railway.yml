name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-railway-${{ github.ref }}
  cancel-in-progress: false

jobs:
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run quick tests
        env:
          ENVIRONMENT: test
          NOTION_API_KEY: test_key
          ANTHROPIC_API_KEY: test_key
        run: |
          pytest tests/ -v --tb=short -x || exit 1

      - name: Verify Docker build
        run: |
          docker build -t executive-mind-matrix:deploy-test .

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    timeout-minutes: 15
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Railway
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          export PATH="$HOME/.railway/bin:$PATH"
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --detach

          # Get the deployment URL
          DEPLOY_URL=$(railway status --json | jq -r '.url')
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        id: health_check
        run: |
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"

            if curl -f -s "${{ steps.deploy.outputs.url }}/health" > /dev/null; then
              echo "Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 10
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Notify on success
        if: success()
        run: |
          echo "Deployment successful to Railway!"
          echo "URL: ${{ steps.deploy.outputs.url }}"

      - name: Rollback on failure
        if: failure() && steps.health_check.outputs.status == 'failed'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          export PATH="$HOME/.railway/bin:$PATH"
          railway rollback
          echo "Deployment failed, rolled back to previous version"

  post-deploy-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install httpx pytest pytest-asyncio

      - name: Run smoke tests
        env:
          API_URL: ${{ needs.deploy.outputs.url }}
        run: |
          # Test health endpoint
          curl -f "$API_URL/health" || exit 1

          # Test root endpoint
          curl -f "$API_URL/" || exit 1

          echo "Smoke tests passed!"

      - name: Monitor deployment
        run: |
          echo "Deployment monitoring initiated"
          echo "Check Railway dashboard for metrics and logs"
